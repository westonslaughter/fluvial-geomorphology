# Fluvial Project

script to retrieve and explore hydraulic goemetry data from Mid-Atlantic USGS stations

```{r}
library(dplyr)
library(ggplot2)
library(ggpmisc)
library(ggpubr)
library(plotly)

library(dataRetrieval)
library(nhdplusTools) # USGS/NHD rivers data



library(sf)
library(mapview) # html mapping
library(leaflet) # html mapping
library(leaflet.extras)
library(here) # setting directories safely
library(viridis) # color scheme
library(USAboundaries) # county/state boundaries
# further geospatial tools
library(nngeo)
library(measurements)
library(lwgeom)
library(elevatr)
library(rgeos)

```

```{r}
# Jones Falls
## siteNo <- c("01589440")
# Gwynns Falls
## siteNo <- c("01589300")
# Rock Creek
## siteNo <- c("01648000")
# Seneca Creek
## siteNo <- c("01645000")
# Bennett Creek
## siteNo <- c("01643500")

siteAll <- c(
            ## # Jones Falls
            ## "01589440",
            ## # Rock Creek
            ## "01648000",
            ## # Seneca Creek
            ## "01645000",
            ## # Bennett Creek
            ## "01643500",
            # Gwynns Falls
            "01589300"
)

# for now,
i = 1
siteNo = siteAll[i]

# query site availability of discarge data
siteDataAvailable <- whatNWISdata(
  siteNumber = siteNo,
  service = "sv",
  statCd = "00060"
)


# query site info
site_info <- dataRetrieval::readNWISsite(siteNo)
site_name <- site_info$station_nm
drainage_area_gage <- site_info$drain_area_va
poi <- c(site_info$dec_long_va, site_info$dec_lat_va)


# create a point from decimal long/lat
hgsite <- st_sfc(st_point(poi), crs = 4326)


```


Now, let's delineate the watershed 


```{r}
library(macrosheds)

xy = st_transform(hgsite, 4326)

st_xy <- st_coordinates(xy)

write_dir = 'final/watersheds/'
write_name = as.character(paste0(site_info$site_no, '_watershed_delin'))

out <- macrosheds::ms_delineate_watershed(
        lat = st_xy[,2],
        long = st_xy[,1],
        crs = 4326,
        write_dir = write_dir,
        write_name = write_name,
        spec_buffer_radius = as.integer(round(drainage_area_gage * 2)),
        spec_snap_distance_m = 150,
        spec_snap_method = 'standard',
        spec_dem_resolution = 10,
        spec_flat_increment = 0.01,
        spec_breach_method = 'basic',
        spec_burn_streams = TRUE,
        verbose = FALSE,
        confirm = FALSE
        )

outfile <- file.path(getwd(), write_dir, paste0(write_name, '.shp'))
watershed_shp <- sf::read_sf(outfile)
mapview(watershed_shp)



```

Now, let's return to the USGS - data. First, let's try and develop a rating curve from annual maximum discharge data

```{r}
# get data start and end dates from USGS record
start.date <- siteDataAvailable$begin_date # "1980-01-01"
end.date <- siteDataAvailable$end_date # "2023-12-31"

# we'll be focusing on the period after 2000
start.date <- as.Date("2000-01-01")

# pull in peak flow data
station.peak = readNWISpeak(siteNumbers = siteNo,
                            startDate = start.date,
                            endDate = end.date)

# pull in FIELD MEASUREMENT channel geometry data for target USGS station
station.hg <- readNWISmeas(siteNumbers = siteNo,
                       # parameterCd = pCode,
                       startDate = start.date,
                       endDate = end.date,
                       expanded = TRUE)

parameterInfo <- attr(station.hg, "variableInfo")
siteInfo <- attr(station.hg, "siteInfo")


# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nField Measurements ", start.date, " to ", end.date
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Log10 Gage Height (m)")
ylab = paste0("Log10 Discharge (m^3/s)")
gg.station.rating <- ggplot(station.hg,
                aes(
                  x = log10(gage_height_va * 0.3048),
                  y = log10(discharge_va * 0.0283168))
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9
                     ) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  xlab(xlab) +
  ylab(ylab) +
  ggtitle(title,
          subtitle = subtitle)
gg.station.rating

```

Looks, bad, let's use a more recent date range to get a consistent curve

```{r}
# Let's try after 2010
start.date <- as.Date("2010-01-01")


# pull in FIELD MEASUREMENT channel geometry data for target USGS station
station.hg <- readNWISmeas(siteNumbers = siteNo,
                       # parameterCd = pCode,
                       startDate = start.date,
                       endDate = end.date,
                       expanded = TRUE)

parameterInfo <- attr(station.hg, "variableInfo")
siteInfo <- attr(station.hg, "siteInfo")


# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nField Measurements ", start.date, " to ", end.date
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Gage Height (m)")
ylab = paste0("Discharge (m^3/s)")
gg.station.rating <- ggplot(station.hg,
                aes(
                  x = gage_height_va * 0.3048,
                  y = discharge_va * 0.0283168)
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9
                     ) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(xlab) +
  ylab(ylab) +
  ggtitle(title,
          subtitle = subtitle)
gg.station.rating

```

Let's look at a time series of peak flows

``` {r}
# start date back to beginning of record
start.date <- siteDataAvailable$begin_date # "1980-01-01"

# pull in peak flow data
station.peak = readNWISpeak(siteNumbers = siteNo,
                            startDate = start.date,
                            endDate = end.date)

# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)

subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nPeak Annual Flow ", start.date, " to ", end.date
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Year")
ylab = paste0("Peak Discharge (m^3/s)")

# get just "year" form peak flow date
station.peak <- station.peak %>%
  mutate(
    year = lubridate::year(peak_dt)
  )

gg.station.peak <- ggplot(station.peak,
                aes(
                  x = year,
                  y = peak_va)
                ) +
        ## stat_poly_line() +
        ## stat_poly_eq(use_label(c("eq", "R2", "p")),
        ##              size = 10,
        ##              label.y = 0.9
        ##              ) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  ## scale_x_log10() +
  scale_y_log10() +
  xlab(xlab) +
  ylab(ylab) +
  ggtitle(title,
          subtitle = subtitle)
gg.station.peak


```

Let's look at flood frequency, or reccurence interval.

``` {r}

# get number years of flow record
station.peak.sum <- station.peak %>%
  group_by(site_no) %>%
  summarize(
    years_record = length(unique(as.character(year)))
  )

# sort and rank flows
station.ri <- station.peak %>%
  arrange(peak_va) %>%
  mutate(
    rank = rank(-peak_va),
    n = station.peak.sum[station.peak.sum$site_no == unique(site_no),]$years_record,
    recurrence_interval = (n + 1)/rank,
    peak_va = peak_va
  )


# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)

subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nWeibull Recurrence Interval, Annual Peak Flows", start.date, " to ", end.date
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Recurrence Interval")
ylab = paste0("Discharge (m^3/s)")


gg.station.ri <- ggplot(station.ri,
                aes(
                  x = recurrence_interval,
                  y = peak_va,
                  ## color = site_no,
                  )
                ) +
        geom_point() +
        ## stat_poly_line() +
        ## stat_poly_eq(use_label(c("eq", "R2", "p")),
        ##              size = 10,
        ##              label.y = 0.85,
        ##              ) +
  ## facet_wrap(~site_no) +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  scale_y_log10() +
  xlab(xlab) +
  ylab(ylab) +
  geom_vline(xintercept = 1.5, col = 'pink') +
  geom_vline(xintercept = 2.33, col = 'blue') +
  ggtitle(title,
          subtitle = subtitle)

gg.station.ri

# inspect to get discharge values
plotly::ggplotly(gg.station.ri)

# get observations cloests to 1.5 yr recurrence interval
station.peak.ri <- station.ri %>%
  group_by(site_no) %>%
  slice(which.min(abs(1.5 - recurrence_interval)))

station.peak.ri_2.33 <- station.ri %>%
  group_by(site_no) %>%
  slice(which.min(abs(2.33 - recurrence_interval)))

for(i in 1:nrow(station.peak.ri)) {
    site <- station.peak.ri[i,]$site_no
    wsRI <- station.peak.ri[i,]$recurrence_interval
    wsQ1.5 <- station.peak.ri[i,]$peak_va

    # bankfull stats from RI 2.33
    station_Qbf_RI2.33 <- station.peak.ri_2.33[i,]$peak_va
    station_Stagebf_RI2.33 <- station.peak.ri_2.33[i,]$gage_ht

    print(paste(site, '--', '1.5 year recurrence interval flow:', wsQ1.5))
    print(paste(site, '--', '2.33 year recurrence interval flow:', station_Qbf_RI2.33))
}

# redo plot with predictive function
gg.station.ri <- ggplot(station.ri,
                aes(
                  x = recurrence_interval,
                  y = peak_va,
                  ## color = site_no,
                  )
                ) +
        geom_point() +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.85,
                     ) +
  ## facet_wrap(~site_no) +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## scale_y_log10() +
  ## scale_x_log10() +
  xlab(xlab) +
  ylab(ylab) +
  geom_vline(xintercept = 1.5, col = 'pink') +
  geom_vline(xintercept = 2.33, col = 'blue') +
  ggtitle(title,
          subtitle = subtitle)

gg.station.ri

station.ri.eq <- function(x) {
    y = 1.27*10**3 + x*314
    
    return(y)
}

ri100 = station.ri.eq(100)
ri1.5 = station.ri.eq(1.5)

print("")
print(paste0("Recurrence Interval 1.5yr: ", ri1.5))
print(paste0("Recurrence Interval 100yr: ", ri100))
print(paste0("Ratio Recurrence Interval 1.5yr:100yr: ", ri1.5/ri100))



```

Dimensionless rating curve, where peak flow and peak flow depth are normalized by sit bankfull Q

``` {r}
# get data start and end dates from USGS record
start.date <- siteDataAvailable$begin_date # "1980-01-01"
end.date <- siteDataAvailable$end_date # "2023-12-31"

# we'll be focusing on the period after 2000
start.date <- as.Date("2000-01-01")

# bankfull Q from 2.33yr recurrence interval
bankfull_discharge_cms = station_Qbf_RI2.33 * 0.3048
bankfull_stage_m = station_Stagebf_RI2.33 * 0.0283168

# pull in peak flow data, and add Qbf normalized flow and gauge height 
station.peak = readNWISpeak(siteNumbers = siteNo,
                            startDate = start.date,
                            endDate = end.date)

station.peak.dmnls <- station.peak %>%
  mutate(
    Q_dmnls = (peak_va * 0.3048) / bankfull_discharge_cms, 
    Stage_dmnls = (gage_ht * 0.0283168) / bankfull_stage_m 
  )

# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\n\nDimensionless Annual Peak Flow and Gage Height, 2.33yr RI Bankfull-normalized\n", start.date, " to ", end.date, "\n")
                   
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Log10 Gage Height (GH/GHbf)")
ylab = paste0("Log10 Peak Flow (Q/Qbf)")
gg.station.rating <- ggplot(station.peak.dmnls,
                aes(
                  x = log10(Q_dmnls),
                  y = log10(Stage_dmnls))
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9
                     ) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  xlab(xlab) +
  ylab(ylab) +
  ggtitle(title,
          subtitle = subtitle)
gg.station.rating

```

Curious about peak flow gage height

```{r}

# plotting standards
title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nPeak Flow and Gage Height", start.date, " to ", end.date, "\n")
                   
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")

# measured rating curve
xlab = paste0("Gage Height (m)")
ylab = paste0("Peak Flow (m^3/s)")
gg.station.peak.rating <- ggplot(station.peak,
                aes(
                  x = gage_ht* 0.0283168,
                  y = peak_va * 0.3048)
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9
                     ) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  scale_color_manual(values = colpal) +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  xlab(xlab) +
  ylab(ylab) +
  ggtitle(title,
          subtitle = subtitle)
gg.station.peak.rating

```

Now, we move into at a statin hydraulic geometry. 

Q = w * d * v

w = aQ<sup>b</sup>
d = cQ<sup>f</sup>
v = kQ<sup>m</sup>

Q = aQ<sup>b</sup> * cQ<sup>f</sup> * kQ<sup>m</sup>

b + f + m = 1
a * c * k = 1


``` {r}


# function which dvelops hydraulic geoemtry equations
hg.rating <- function(discharge, hg_var, verbose = FALSE, convert = TRUE) {

    if(convert) {
      # convert CFS to cms
        discharge <- discharge *  0.0283168
      # convert ft to m
        hg_var <- hg_var * 0.3048
    }

    Q = log10(discharge)
    hg = log10(hg_var)

    hg[is.infinite(hg)] <- NA

    # linear model of log10 data, of form lm(y ~ x)
    rating.eq = lm(hg ~ Q)

    a = 10**rating.eq$coefficients[[1]]
    b = rating.eq$coefficients[[2]]
    rating.eq.coef_exponent = c(a, b)

    if(verbose == TRUE) {
        print(rating.eq.coef_exponent)
    }

    return(rating.eq.coef_exponent)
}

hg.rating.calc <- function(discharge, a, b, convert = TRUE) {

    if(convert) {
        discharge <- discharge *  0.0283168
        hg_var <- hg_var * 0.3048
    }

    Q = discharge

    hg.calc = a*(Q**b)

    return(hg.calc)
}

# downstream HG
hg.pgds <- function(hg_depth, # channel depth
                    hg_velocity, # channel mean velocity
                    acceleration = 9.814, # gravity
                    slope = 0.00962855, # slope of channel
                    p = 1000, # mass density water
                    convert = FALSE # if inputs in imperial system
                    ) {

    # tau, t, also "Shear Stress", see Leopold, Wolman, Miller pg 153
    # t = Force / Channel Boundary Area = pgRS ~ pgdS
    # p = mass density of water = 1000
    # g = acceleration due to gravity  = 9.814
    # R = hydraulic radius ~ depth
    # S = slope

    if(convert) {
        discharge <- discharge *  0.0283168
        hg_var <- hg_var * 0.3048
    }

    pgds = p * acceleration * hg_depth * slope

    return(pgds)
}

hg.resistance <- function(pgds, hg_velocity) {
    resistance = pgds / (hg_velocity**2) # Leopold,W,M pg 157
    return(resistance)
}

# resistance and slope by valeoctiy over depth
#  S**0.5 / n = U/d**0.67
hg.sn.slope <- function(hg_depth, hg_velocity, n = 0.035, metric = "sn") {

    U = hg_velocity
    d = hg_depth

    sn = U/(d**0.67)
    slope = (sn*n)**2 # NOTE: manning coefficient unit conversion issue?

    if(metric == "sn") {
        return(sn)
    } else if(metric == "slope"){
        return(slope)
    } else {
        warning("error: invalid metric input, provide either 'sn', 'slope', or no input which will default to sn")
    }
    
}



```

Prepare USGS field measurement data for HG analysis

``` {r}
# run with full timeframe for time series analysis
# get data start and end dates from USGS record
start.date <- siteDataAvailable$begin_date # "1980-01-01"
end.date <- siteDataAvailable$end_date # "2023-12-31"

# pull in FIELD MEASUREMENT channel geometry data for target USGS station
station.hg <- readNWISmeas(siteNumbers = siteNo,
                       # parameterCd = pCode,
                       startDate = start.date,
                       endDate = end.date,
                       expanded = TRUE)

# filter and enhance field measurements dataframe
station.hg.df <- station.hg %>%
    rename(datetime = measurement_dt) %>%
    filter(
      # two measurements at beggining of record (1956, 1957) both major outliers
      ## lubridate::year(datetime) > 1960,
      # measurement of Q way higher than all others, mid width, removing
      discharge_va < 15000,
      # remove all the measurements labelled "poor", "unspecified",
      measured_rating_diff  != "Poor",
      measured_rating_diff  != "Unspecified",
    ) %>%
    mutate(
      # useful time aggregations
      year = lubridate::year(datetime),
      decade = year - (year %% 10),
      half_decade = case_when(year <= (decade + 5) ~ decade,
                              year > (decade + 5) ~ decade + 5),
      # convert all HG variables intor metric
      discharge_cms = discharge_va * 0.0283168,
      chan_width_m = chan_width * 0.3048,
      chan_area_sqm = chan_area * 0.3048,
      chan_velocity_ms = chan_velocity * 0.3048,
      gage_ht_m = gage_height_va * 0.3048,
      # depth as function of channel area divided by width
      chan_depth_m = chan_area / chan_width,
      # continue with conversion 
      # log10 versios of HG variables
      chan_discharge_log10 = log10(discharge_cms),
      chan_width_log10 = log10(chan_width_m),
      chan_area_log10 = log10(chan_area_sqm),
      chan_depth_log10 = log10(chan_depth_m),
      chan_velocity_log10 = log10(chan_velocity_ms),
      gage_height_va_log10 = log10(gage_ht_m),
      # apply sn and slope equations
      chan_sn = hg.sn.slope(chan_depth_m, chan_velocity_ms, metric = "sn") ,
      chan_slope = hg.sn.slope(chan_depth_m, chan_velocity_ms, metric = "slope"),
      # apply pgdS equation
      shear_stress = hg.pgds(chan_depth_m, chan_velocity_ms, slope = chan_slope),
      resistance = hg.resistance(shear_stress, chan_velocity_ms)
    )


```

Apply HG equations to all station data

```{r}


# overall rating equations
print("width:")
station.w.eq <- hg.rating(discharge = station.hg.df$discharge_cms, hg_var = station.hg.df$chan_width_m, verbose = T)

print("depth:")
station.d.eq <- hg.rating(discharge = station.hg.df$discharge_cms, hg_var = station.hg.df$chan_depth_m, verbose = T)

print("velocity:")
station.v.eq <- hg.rating(discharge = station.hg.df$discharge_cms, hg_var = station.hg.df$chan_velocity_ms, verbose = T)

```

Apply these coefficients and exponents to the data

```{r}
# plot all time HG change
station.hg.calc <- station.hg.df %>%
  group_by(half_decade) %>%
  summarize(
      hg_exp_w  = hg.rating(discharge = discharge_va, hg_var = chan_width_m, verbose = F)[[2]],
      hg_exp_d  = hg.rating(discharge = discharge_va, hg_var = chan_depth_m, verbose = F)[[2]],
      hg_exp_v  = hg.rating(discharge = discharge_va, hg_var = chan_velocity_ms, verbose = F)[[2]],
      hg_coef_w = hg.rating(discharge = discharge_va, hg_var = chan_width_m, verbose = F)[[1]],
      hg_coef_d = hg.rating(discharge = discharge_va, hg_var = chan_depth_m, verbose = F)[[1]],
      hg_coef_v = hg.rating(discharge = discharge_va, hg_var = chan_velocity_ms, verbose = F)[[1]],
  ) %>%
  tidyr::pivot_longer(cols = c(
                           hg_exp_w,
                           hg_exp_d,
                           hg_exp_v,
                           hg_coef_w,
                           hg_coef_d,
                           hg_coef_v),
                      names_to = "var",
                      values_to = "val")

```

plot

```{r}

title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\nHydraulic Geometry ", start.date, " to ", end.date, "\n\n"
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")


xlab = paste0("Year")
ylab = paste0("Half Decade Hydraulic Geometry Equation Value")

# Science Notes
# - flood event ticks
# - NAO index annual ts?
# - GEE gravel bar ts
# Figure Notes:
# - set x-axis to lowest start across sites
# - set half_decades to always same across sites?
# - set y axis to lowest/highest log10(val)
# - set d, w, v to same color (nice color)
## gg.station.coef <- ggplot(station.hg.calc[grepl('coef', station.hg.calc$var),],
gg.station.coef <- ggplot(station.hg.calc,
                aes(
                  x = half_decade,
                  y = val,
                  color = var)
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9 * c(0.75, 0.8, 0.85),
                     ) +
  facet_wrap(~var) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  xlab(xlab) + 
  ylab(ylab) +
  scale_color_manual(values = colpal) +
  scale_y_log10() +
  ## ylim(-1.5, 1.5) +
  xlim(1930, 2020) +
  ggtitle(title,
          subtitle = subtitle)

gg.station.coef

# sn, slope by discharge, in recent era
station.hg.df.2010_Now <- station.hg.df %>%
  filter(year > 2010)

title <- paste0(siteInfo$agency_cd, "-",
                siteInfo$site_no, "  ",
                siteInfo$station_nm)
subtitle <- paste0("Drainage Area: ", siteInfo$drain_area_va, " sqmi        ",
                   "lat, long:  ", siteInfo$dec_lat_va,
                   ",",
                   " ", siteInfo$dec_long_va,
                   "\n", start.date, " to ", end.date, "\n"
                   )
colpal <- c("#A31621", "#FCB514", "#053C5E", "#A3162198", "#FCB51498", "#053C5E98")


xlab = paste0("Discharge (cms)")
ylab = paste0("Slope")
gg.station.q_slope <- ggplot(station.hg.df.2010_Now,
                aes(
                  x = chan_discharge,
                  y = chan_slope)
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.9 * c(0.75, 0.8, 0.85),
                     ) +
  ## facet_wrap(~) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  xlab(xlab) + 
  ylab(ylab) +
  scale_color_manual(values = colpal) +
  scale_y_log10() +
  scale_x_log10() +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  ggtitle(title,
          subtitle = subtitle)

gg.station.q_slope


xlab = paste0("Discharge (cms)")
ylab = paste0("Resistance")
gg.station.q_resistance <- ggplot(station.hg.df.2010_Now,
                aes(
                  x = chan_discharge,
                  y = resistance)
                ) +
        stat_poly_line() +
        stat_poly_eq(use_label(c("eq", "R2", "p")),
                     size = 10,
                     label.y = 0.2 * c(0.75, 0.8, 0.85),
                     ) +
  ## facet_wrap(~) +
  geom_point() +
  theme_bw() +
  theme(text = element_text(size = 34)) +
  xlab(xlab) + 
  ylab(ylab) +
  scale_color_manual(values = colpal) +
  ## scale_y_log10() +
  scale_x_log10() +
  ## ylim(-1.5, 1.5) +
  ## xlim(1930, 2020) +
  ggtitle(title,
          subtitle = subtitle)

gg.station.q_resistance

```

Show bankfull station geometry

```{r}

qbf_cms = station_Qbf_RI2.33 * 0.0283168

print(paste(site, '--', '2.33 year recurrence interval flow (cms):', qbf_cms))

# get observations cloests to 1.5 yr recurrence interval
station.bankfull <- station.hg.df.2010_Now %>%
  group_by(site_no) %>%
  slice(which.min(abs(qbf_cms - discharge_cms)))

bankfull_properties = list(
    "bankfull_depth" =        station.bankfull$chan_depth_m,
    "bankfull_width" =        station.bankfull$chan_width_m,
    "bankfull_velocity" =     station.bankfull$chan_velocity_ms,
    "bankfull_resistance" =   station.bankfull$resistance,
    "bankfull_shear_stress" = station.bankfull$shear_stress,
    "bankfull_slope" =        station.bankfull$chan_slope
)

print(bankfull_properties)

```
